<!DOCTYPE html><html><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"><meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0,user-scalable=no"/><link rel="shortcut icon" href="/favicon.ico" /><title>新浪微博JS SDK API的使用 - Xheldon</title><meta name="author" content="Xheldon" /><meta name="description" content="新浪微博JS SDK API的使用" /><meta name="keywords" content="新浪微博JS SDK API的使用, Xheldon, Javascript" /><link rel="alternate" type="application/rss+xml" title="RSS" href="/feed.xml"><meta content="" property="fb:app_id"><meta content="Xheldon" property="og:site_name"><meta content="新浪微博JS SDK API的使用" property="og:title"><meta content="article" property="og:type"><meta content="会点前端，在学 Node、Electron、ProseMirror" property="og:description"><meta content="https://xheldon.com/tech/weibo-jssdk.html" property="og:url"><meta content="2015-12-21T13:23:45+00:00" property="article:published_time"><meta content="https://xheldon.com/about/" property="article:author"><meta content="/resource/img/logo_min.png" property="og:image"><meta content="Javascript" property="article:section"><meta name="twitter:card" content="summary"><meta name="twitter:site" content="@"><meta name="twitter:creator" content="@"><meta name="twitter:title" content="新浪微博JS SDK API的使用"><meta name="twitter:url" content="https://xheldon.com/tech/weibo-jssdk.html"><meta name="twitter:description" content="会点前端，在学 Node、Electron、ProseMirror"><style type="text/css"> /* Project Elements */ .project-outer { display: inline-block; min-width: 30%; max-width: 45%; vertical-align: top; margin: 0 1.6%; overflow: hidden; } .project-img img { width: 100%; } h3.project-headlines { margin: 5px 0; font-size: 20px; } span.tags { font-size: 10px; border-bottom: 1px #888 dotted; margin: 0 5px; } span.tags:first-child { margin-left: 0; } span.tags:last-child { margin-right: 0; } .project-footer { clear: both; display: inline-block; width: 100%; } .project-footer .project-link { display: inline-block; position: relative; float: left; text-decoration: none; } .project-footer .project-timeline { display: inline-block; position: relative; float: right; font-size: 13px; font-style: italic; } .project-inner>a { display: block; } .project-img { width: 100%; height: 200px; display: block; background-size: contain; background-repeat: no-repeat; background-position: center center; } /** Project Tag Filters **/ .tag-group { margin: 0 0 25px 0; } span.tag-cloud { margin: 0 2px; cursor: pointer; font-size: 75%; padding: .2em .6em .3em; font-weight: 700; display: inline; } .tag-cloud.active { background: #ccc; } .project-item.not-show { display: none; } a.project-detail:hover { text-decoration: none; } a.project-detail:hover h3 { color: #428bca; }</style><link rel="stylesheet" href="/resource/css/main.css?t=20190911161844"><body><div class="container" id="container-post"><header id="header-post"> <a href="/"><img class="profile-avatar" src="/resource/img/logo_min.png" height="75px" width="75px" /></a><nav class="navlinks"><li><a class="about" href="https://42.xheldon.com/about/">我</a><li><a class="about" href="/book-list/">书单</a><li><a class="about" href="/projects/">项目</a><li><a class="about" href="/donate/">赞赏</a><li><a class="about" href="/feed.xml">订阅</a></nav><div class="search" id="js-search"> <input type="text" placeholder="搜索一下" class="search__input form-control" id="js-search__input"><ul class="search__results" id="js-search__results"></ul></div></header><main class="main-layout" id="page-post"><aside id="toc"><ul id="my_toc"><li><a href="#前言">前言</a><li><a href="#现状">现状</a><li><a href="#我的做法">我的做法</a></ul></aside><article class="post"><section class="post-header"><h1 class="post-title">新浪微博JS SDK API的使用</h1><div> <time class="time">2015年12月21日</time> <span class="categories"> &raquo; <a href="/category/Javascript">Javascript</a> </span></div></section><div class="time-tips">注意：离本文创建时间已经过去了 <code>2025</code> 天, 请注意时效性</div><h2 id="前言">前言</h2><p>以前整个网站都是老大一个人怼起来的,各种bug和各种细节不完善.所以打算重构一下,侯哥搭好了<code class="language-plaintext highlighter-rouge">seajs</code>的开发框架,因此我只需要写前端逻辑即可.<h2 id="现状">现状</h2><p>注册和登陆部分是我写的,因此我打算增加个新浪微博和QQ登陆的功能,用户点击之后存储其id到数据库,当然这个需要修改数据库表字段,单独增加一个类似于<code class="language-plaintext highlighter-rouge">wb_id</code>的字段名来标示.<p>现在流行的做法有两种,一个是用新浪微博(或其他登录方式,下同)登陆之后,后台自动创建一个id作为本站唯一的标示,同一行的wb_id存储此用户的微博id,以后用任意账号登陆即可,第一次微博登陆之后用户只需要设置一下昵称(非必须,可直接使用微博昵称)和密码(必须,因为万一以后新浪微博倒闭了,用户没法儿登陆可不行);另一种方式是新浪微博登陆之后需要引导用户手动创建一个账号和密码,或者引导用户绑定到已经注册过的用户账号上去.<h2 id="我的做法">我的做法</h2><p>好了以上是业务逻辑,我会使用第一种方式实现,下面是具体的实现方法:如何使用新浪微博的JSSDK的API. 首先和网上大多数教程里面说的那样,需要了解OAuth2.0协议的原理,其实不了解也没关系,知道流程就行,OAuth2.0验证流程网上说的很多了,百度一大把,这里就不再赘述了.<p>注意:所有步骤的前提是,你已经取得了新浪微博开放平台的开发者权限,如果没有的话是无权调用API的,关于新浪微博开发者申请,请自行百度.申请完新浪微博开发者之后会到一个appid,这个是新浪识别谁调用了它的API的关键id,之后的步骤也会用到.<p>第一步:增加命名空间,引用jssdk文件.<p>增加命名空间:<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;html</span> <span class="na">xmlns:wb=</span><span class="s">”http://open.weibo.com/wb”</span><span class="nt">&gt;</span>
</code></pre></div></div><p>引用jssdk文件:<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;script </span><span class="na">src=</span><span class="s">”http://tjs.sjs.sinajs.cn/open/api/js/wb.js?appkey=YOUR</span> <span class="na">APPKEYdebug=</span><span class="s">true”</span> <span class="na">type=</span><span class="s">”text/javascript”</span> <span class="na">charset=</span><span class="s">”utf-8″</span><span class="nt">&gt;&lt;/script&gt;</span>
</code></pre></div></div><p>其中的<code class="language-plaintext highlighter-rouge">YOUR APPKEY</code>替换为你申请新浪微博开发者时它给你的<code class="language-plaintext highlighter-rouge">appid</code>, <code class="language-plaintext highlighter-rouge">debug=true</code>方便你调试,正式上线时可以把<code class="language-plaintext highlighter-rouge">&amp;debug=true</code>这个给删掉.<p>第二步:使用API授权登录<p>这里有两种方式,一种是点击按钮之后直接在脚本里调用API的<code class="language-plaintext highlighter-rouge">WB2.login()</code>方法具体请看新浪API,<p>还一种是将用户引导到包含你appid和回调地址的地址中去(姑且叫它授权页),格式为:<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">https</span><span class="p">:</span><span class="c1">//api.weibo.com/2/oauth2/authorize?client_id=YOUR APPKEY&amp;response_type=token&amp;display=js&amp;transport=html5&amp;referer=Your_CallBack_Address</span>
</code></pre></div></div><p>其中的<code class="language-plaintext highlighter-rouge">YOUR APPKEY</code>和<code class="language-plaintext highlighter-rouge">Your_CallBack_Address</code>替换为你自己的,注意<code class="language-plaintext highlighter-rouge">Your_CallBack_Address</code>记得加上<code class="language-plaintext highlighter-rouge">http://</code> 比如我的测试引导地址就是:<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">https</span><span class="p">:</span><span class="c1">//api.weibo.com/2/oauth2/authorize?client_id=2177891434&amp;response_type=token&amp;display=js&amp;transport=html5&amp;referer=http://www.xheldon.com/gbtagsLogin.html</span>
</code></pre></div></div><p>注意:貌似这个回调地址必须是以php/html/jsp等动态/非动态的带后缀名的格式,如果是首页的话比如<code class="language-plaintext highlighter-rouge">http://xheldon.com</code>是不行的,需要加上<code class="language-plaintext highlighter-rouge">http://xheldon.com/index.html</code>(因为我的后台是Node的)才行,这个我没有试过,有需要的同学请自行尝试.<p>第一种方法的表现形式是点击引导入口之后会直接弹出微博登陆授权页面的对话框,这个时候如果你用过的是<code class="language-plaintext highlighter-rouge">chrome</code>的话会发现在这个小窗口的地址栏左侧的地址有个小锁icon,代表这个地址是锁定的无法修改. 在弹出的小窗口输入微博登陆账号密码授权之后对话框消失,原来的页面刷新,第三方网站就可以操作你的账号.<p>第二种方法是不在脚本中使用<code class="language-plaintext highlighter-rouge">WB2.login()</code>,而是引导用户到刚才我说的那个包含appid和回调地址的地址中去,这个地址也是会让你输入账号密码,但是这个和第一种方式的区别是这个是会离开现有的页面跳转到这个授权页中去的,输入账号密码授权之后会回到你这个链接中写的回调地址中去.<p>以上两步的原理其实就是<code class="language-plaintext highlighter-rouge">OAuth2.0</code>协议认证的过程,只是JSSDK给你处理好了第一次请求返回的code和第二次请求返回的<code class="language-plaintext highlighter-rouge">access token</code>,因此你不需要按照官方API里面说的那样运用<code class="language-plaintext highlighter-rouge">basic</code>方式将<code class="language-plaintext highlighter-rouge">access token</code>放到<code class="language-plaintext highlighter-rouge">header</code>中使用post或者get方式等一系列你可能听不懂的名词,而只需要关注前端的逻辑,使用获得的json格式的数据即可.<p>还是刚才那个地址, <a href="http://open.weibo.com/wiki/Weibo-JS_V2">微博API入口级文档说明</a>.当然”入口级”这个名词 是我自创的,你知道了这五个的用法,以后的API就可以依葫芦画瓢了.<p>这几个API其中的<code class="language-plaintext highlighter-rouge">WB2.login()</code> 和<code class="language-plaintext highlighter-rouge">WB2.checklogin()</code>以及<code class="language-plaintext highlighter-rouge">WB2.logout</code>比较简单,是个人都能看懂,看不懂的按照我刚才说的那个<code class="language-plaintext highlighter-rouge">WB2.login()</code>方法往script标签里面一放就可以了,只是引导登陆之后你什么也没有做.<p>登陆之后想做点什么的话(这是废话,不做什么你让人家登陆干啥),比如获取登陆新浪微博登陆用户的id,获取它的粉丝数等等,都是通过这五个入口级API的最重要的一个API 即与微博API进行数据交互及采用Js方式调用内置微博组件的入口函数(官方是这么介绍的):<code class="language-plaintext highlighter-rouge">WB2.anyWhere(callback)</code>,<p>然后与数据交互的话需要使用<code class="language-plaintext highlighter-rouge">W.parseCMD(uri, callback, args, opts)</code> 其中W形参是<code class="language-plaintext highlighter-rouge">WB2.anyWhere(callback)</code>传进去的,如果想调用微博组件的话,可以使用<code class="language-plaintext highlighter-rouge">W.widget.hoverCard(…)</code>或者<code class="language-plaintext highlighter-rouge">W.widget.followButton(…);</code>等等.<p>注意,最最重要的一步,即是你和新浪的数据交互的一步:<p>一般<code class="language-plaintext highlighter-rouge">W.parseCMD</code>的用法是以下形式:<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">W</span><span class="p">.</span><span class="nx">parseCMD</span><span class="p">(</span><span class="dl">'</span><span class="s1">/users/show.json</span><span class="dl">'</span><span class="p">,</span><span class="err"> </span><span class="kd">function</span><span class="p">(</span><span class="nx">oResult</span><span class="p">,</span> <span class="nx">bStatus</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span><span class="p">(</span><span class="nx">bStatus</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">//to do something...</span>
  <span class="p">}</span>
  <span class="p">},</span> <span class="p">{</span>
	<span class="na">screen_name</span> <span class="p">:</span> <span class="dl">'</span><span class="s1">姚晨</span><span class="dl">'</span>
  <span class="p">},</span> <span class="p">{</span>
	<span class="na">method</span> <span class="p">:</span> <span class="dl">'</span><span class="s1">get</span><span class="dl">'</span><span class="p">,</span>
	<span class="na">cache_time</span> <span class="p">:</span> <span class="mi">30</span>
  <span class="p">});</span>
</code></pre></div></div><p>其中<code class="language-plaintext highlighter-rouge">W.parseCMD()</code>的第一个参数<code class="language-plaintext highlighter-rouge">/user/show.json</code>可以换成其他的接口如:<code class="language-plaintext highlighter-rouge">/statuses/user_timeline.json</code>就可以读取这个借口的信息了,具体有哪些接口,而接口又能返回哪些数据,新浪自己给了个 <a href="http://open.weibo.com/tools/apitest.php">微博API测试工具</a> 注意:这个API测试工具的登陆界面有问题,请不要在这个页面登陆,而是先到微博首页登陆之后再在这个API测试工具的页面刷新即可. 那个<code class="language-plaintext highlighter-rouge">screen_name</code>不是必须的,但是<code class="language-plaintext highlighter-rouge">screen_name</code>所在的{}必须保留,即使它是空的.<p>下面的<code class="language-plaintext highlighter-rouge">method: get</code>是与后台交互时的参数,有时候的交互是需要使用<code class="language-plaintext highlighter-rouge">post</code>方式,<code class="language-plaintext highlighter-rouge">cache_time</code>看名字也知道什么意思吧?就不多说了.<p>差不多需要注意的就这么多.</article><div class="page-footer"><hr /> 转载请<a href="/tech/weibo-jssdk.html">注明出处</a>&nbsp;&nbsp;打赏请<a href="/donate/" target="_blank">移步这里</a> <br><br> <span class="EOF">- EOF -</span> <br><br><div class="panel-body"><h4>相同分类:</h4><ul><li class="relatedPost"> <a href="/tech/sinon-es6-module-test.html">使用 Sinon 测试 ES6 模块</a> (分类: <a href="/category/Javascript">Javascript</a>)</ul></div><div class="page-navigation"> <a class="prev" href="/tech/promise-antipattern.html">&laquo; [译] Promise 反面模式</a> <a class="next" href="/tech/how-to-work.html">关于代码优化/工作经验重要性的一次切身体会 &raquo;</a></div><div id="gitalk-container"></div></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css"> <script src="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js"></script> <script type="text/javascript"> window.addEventListener('load', function(){ var gitalk = new Gitalk({ clientID: 'd2b353a60fa1233163fc', clientSecret: '8091d57674976bcd60fc05261bf93c00da7e5ff4', repo: 'x_blog', owner: 'Xheldon', admin: ['Xheldon'], id: "weibo-jssdk" }); gitalk.render('gitalk-container'); }); </script></main><footer> &copy; 2021 - Xheldon - Theme Powered By Xheldon <span class="footer-social"> <a href="https://twitter.com/_Xheldon" target="_blank"><i class="fab fa-twitter"></i></a> <a href="https://t.me/xheldon_saloon" target="_blank"><i class="fab fa-telegram"></i></a> <a href="https://www.zhihu.com/people/xheldon/pins" target="_blank"><i class="fa" style="font-size: 16px;line-height:2;">知乎</i></a> </span></footer></div><script type="text/javascript"> !function () { function e(t) { var n = {}; if (1 == t.nodeType) { if (t.attributes.length > 0) { n["@attributes"] = {}; for (var i = 0; i < t.attributes.length; i++) { var s = t.attributes.item(i); n["@attributes"][s.nodeName] = s.nodeValue } } } else 3 == t.nodeType && (n = t.nodeValue); var a = [].slice.call(t.childNodes).filter(function (e) { return 3 === e.nodeType }); if (t.hasChildNodes() && t.childNodes.length === a.length) n = [].slice.call(t.childNodes).reduce(function (e, t) { return e + t.nodeValue }, ""); else if (t.hasChildNodes()) for (var r = 0; r < t.childNodes.length; r++) { var o = t.childNodes.item(r), d = o.nodeName; if ("undefined" == typeof n[d]) n[d] = e(o); else { if ("undefined" == typeof n[d].push) { var c = n[d]; n[d] = [], n[d].push(c) } n[d].push(e(o)) } } return n } function t(t) { var n = e(t); return n.channel.item } var n, i = document.querySelector("#js-search"), s = document.querySelector("#js-search__input"), a = document.querySelector("#js-search__results"), r = "", o = [], d = new XMLHttpRequest; d.open("GET", "/sitemap.xml"), d.onreadystatechange = function () { if (4 == d.readyState && (200 == d.status || 304 == d.status)) { var e = (new DOMParser).parseFromString(d.responseText, "text/xml"); e = e.children[0], o = t(e) } }, d.send(), window.toggleSearch = function () { _gaq.push(["_trackEvent", "supersearch", i.classList.contains("is-active")]), i.classList.toggle("is-active"), i.classList.contains("is-active") ? s.value = "" : a.classList.add("is-hidden"), setTimeout(function () { s.focus() }, 210) }, window.addEventListener("keyup", function (e) { 27 === e.which && toggleSearch() }), window.addEventListener("keypress", function (e) { 47 !== e.which || i.classList.contains("is-active") || toggleSearch() }), s.addEventListener("input", function () { var e, t; if (r = (s.value + "").toLowerCase(), !r || r.length < 3) return n = "", void a.classList.add("is-hidden"); a.style.offsetWidth; var i; i = void 0 === o.title ? o.filter(function (e) { return -1 !== (e.title + "").toLowerCase().indexOf(r) || -1 !== (e.description + "").toLowerCase().indexOf(r) ? !0 : void 0 }) : [o], i.length || a.classList.add("is-hidden"), e = i.reduce(function (e, t) { return t.title + e }, ""), i.length && e !== n && (a.classList.remove("is-hidden"), a.innerHTML = i.map(function (e) { return t = new Date(e.pubDate), '<li><a href="' + e.link + '">' + e.title + "</a>" }).join("")), n = e }) }(); </script><link href="https://cdn.jsdelivr.net/gh/xheldon/x_blog-static@master/css/font-awesome.min.css" rel="stylesheet" crossorigin="anonymous"> <script> (function (i, s, o, g, r, a, m) { i['GoogleAnalyticsObject'] = r; i[r] = i[r] || function () { (i[r].q = i[r].q || []).push(arguments) }, i[r].l = 1 * new Date(); a = s.createElement(o), m = s.getElementsByTagName(o)[0]; a.async = 1; a.src = g; m.parentNode.insertBefore(a, m) })(window, document, 'script', 'https://www.google-analytics.com/analytics.js', 'ga'); ga('create', 'UA-79359216-1', 'auto'); ga('send', 'pageview'); </script> <script> document.addEventListener('DOMContentLoaded',function(){ try { Array.prototype.slice.call(document.querySelectorAll('a')).forEach(function(a){ if (!a.getAttribute('target')) { let href = a.getAttribute('href'); let attrs = Object.keys(a.dataset); if (href && href.indexOf('/') && href.indexOf('#')) { a.setAttribute('target', '_blank'); } else { a.setAttribute('target', '_self'); } /* 默认情况下外链在新窗口打开, 本地链接在当前窗口打开 kramdown 可以对 url 设置特殊属性 data-open, 因此用此特性来排除需要在新窗口打开的本地链接 */ if (attrs.length) { attrs.forEach(function(attr){ switch (attr) { case 'open': a.setAttribute('target', '_blank'); break; default: break; } }); } } }); } catch (e) { console.log('新窗口打开链接失败:', e); } /*try { let toc = document.getElementById('post-toc'); if (toc) { function setPosition() { let offset = toc.parentElement.getBoundingClientRect().y; if (offset <= 50) { toc.style.position = 'fixed'; toc.style.top = '50px'; } else { toc.style.position = 'absolute'; toc.style.top = '0'; } } setPosition(); window.addEventListener('scroll', setPosition); } } catch(e) { console.log('toc滚动失败'); }*/ }); </script>
