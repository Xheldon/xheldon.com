<!DOCTYPE html><html><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"><meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0,user-scalable=no"/><link rel="shortcut icon" href="/favicon.ico" /><title>我对 CORS 的探究 - Xheldon</title><meta name="author" content="Xheldon" /><meta name="description" content="我对 CORS 的探究" /><meta name="keywords" content="我对 CORS 的探究, Xheldon, Web" /><link rel="alternate" type="application/rss+xml" title="RSS" href="/feed.xml"><meta content="" property="fb:app_id"><meta content="Xheldon" property="og:site_name"><meta content="我对 CORS 的探究" property="og:title"><meta content="article" property="og:type"><meta content="会点前端，在学 Node、Electron、ProseMirror" property="og:description"><meta content="https://xheldon.com/tech/research-CORS.html" property="og:url"><meta content="2016-07-07T12:56:45+00:00" property="article:published_time"><meta content="https://xheldon.com/about/" property="article:author"><meta content="/resource/img/logo_min.png" property="og:image"><meta content="Web" property="article:section"><meta name="twitter:card" content="summary"><meta name="twitter:site" content="@"><meta name="twitter:creator" content="@"><meta name="twitter:title" content="我对 CORS 的探究"><meta name="twitter:url" content="https://xheldon.com/tech/research-CORS.html"><meta name="twitter:description" content="会点前端，在学 Node、Electron、ProseMirror"><style type="text/css"> /* Project Elements */ .project-outer { display: inline-block; min-width: 30%; max-width: 45%; vertical-align: top; margin: 0 1.6%; overflow: hidden; } .project-img img { width: 100%; } h3.project-headlines { margin: 5px 0; font-size: 20px; } span.tags { font-size: 10px; border-bottom: 1px #888 dotted; margin: 0 5px; } span.tags:first-child { margin-left: 0; } span.tags:last-child { margin-right: 0; } .project-footer { clear: both; display: inline-block; width: 100%; } .project-footer .project-link { display: inline-block; position: relative; float: left; text-decoration: none; } .project-footer .project-timeline { display: inline-block; position: relative; float: right; font-size: 13px; font-style: italic; } .project-inner>a { display: block; } .project-img { width: 100%; height: 200px; display: block; background-size: contain; background-repeat: no-repeat; background-position: center center; } /** Project Tag Filters **/ .tag-group { margin: 0 0 25px 0; } span.tag-cloud { margin: 0 2px; cursor: pointer; font-size: 75%; padding: .2em .6em .3em; font-weight: 700; display: inline; } .tag-cloud.active { background: #ccc; } .project-item.not-show { display: none; } a.project-detail:hover { text-decoration: none; } a.project-detail:hover h3 { color: #428bca; }</style><link rel="stylesheet" href="/resource/css/main.css?t=20190911161844"><body><div class="container" id="container-post"><header id="header-post"> <a href="/"><img class="profile-avatar" src="/resource/img/logo_min.png" height="75px" width="75px" /></a><nav class="navlinks"><li><a class="about" href="https://42.xheldon.com/about/">我</a><li><a class="about" href="/book-list/">书单</a><li><a class="about" href="/projects/">项目</a><li><a class="about" href="/donate/">赞赏</a><li><a class="about" href="/feed.xml">订阅</a></nav><div class="search" id="js-search"> <input type="text" placeholder="搜索一下" class="search__input form-control" id="js-search__input"><ul class="search__results" id="js-search__results"></ul></div></header><main class="main-layout" id="page-post"><aside id="toc"><ul id="my_toc"><li><a href="#本文由来">本文由来</a><li><a href="#小目标-1-简单请求下让-acom-发送-ajax-到-bcom">小目标-1: 简单请求下让 <code class="language-plaintext highlighter-rouge">a.com</code> 发送 <code class="language-plaintext highlighter-rouge">ajax</code> 到 <code class="language-plaintext highlighter-rouge">b.com</code></a><li><a href="#小目标-2-本地服务接收前端的-cookie">小目标-2: 本地服务接收前端的 <code class="language-plaintext highlighter-rouge">cookie</code></a><li><a href="#小目标-3-把-acom-的-cookie-发送到-bcom">小目标-3: 把 <code class="language-plaintext highlighter-rouge">a.com</code> 的 <code class="language-plaintext highlighter-rouge">cookie</code> 发送到 <code class="language-plaintext highlighter-rouge">b.com</code></a><li><a href="#额外定一个小目标-非简单请求">额外定一个小目标: 非简单请求</a><li><a href="#小目标-4-把-acom-域下的-cookie-发送到-bcom">小目标-4: 把 <code class="language-plaintext highlighter-rouge">a.com</code> 域下的 <code class="language-plaintext highlighter-rouge">cookie</code> 发送到 <code class="language-plaintext highlighter-rouge">b.com</code></a><li><a href="#小目标-5-acom-的-javascript-获取-bcom-的-cookie">小目标-5: <code class="language-plaintext highlighter-rouge">a.com</code> 的 <code class="language-plaintext highlighter-rouge">JavaScript</code> 获取 <code class="language-plaintext highlighter-rouge">b.com</code> 的 <code class="language-plaintext highlighter-rouge">cookie</code>:</a><li><a href="#联想">联想</a><li><a href="#后记">后记</a><li><a href="#注意">注意</a></ul></aside><article class="post"><section class="post-header"><h1 class="post-title">我对 CORS 的探究</h1><div> <time class="time">2016年07月07日</time> <span class="categories"> &raquo; <a href="/category/Web">Web</a> </span></div></section><div class="time-tips">注意：离本文创建时间已经过去了 <code>1826</code> 天, 请注意时效性</div><h2 id="本文由来">本文由来</h2><p>看网上某篇 <code class="language-plaintext highlighter-rouge">CORS</code> 资料的时候, 被一句话迷惑了: ‘注意, 设置了 <code class="language-plaintext highlighter-rouge">withCredentials = true</code> 之后, 携带的 <code class="language-plaintext highlighter-rouge">cookie</code> 是目标域的 <code class="language-plaintext highlighter-rouge">cookie</code>’, 我十分不解: 当前域假设为 <code class="language-plaintext highlighter-rouge">a.com</code> 发送 <code class="language-plaintext highlighter-rouge">xhr</code> 到 <code class="language-plaintext highlighter-rouge">b.com</code>, 当然是把源域 <code class="language-plaintext highlighter-rouge">a.com</code> 的 <code class="language-plaintext highlighter-rouge">cookie</code>, 发送给 <code class="language-plaintext highlighter-rouge">b.com</code> 来处理啊, 怎么会携带的是目标域(这里我理解为 <code class="language-plaintext highlighter-rouge">b.com</code>)的 <code class="language-plaintext highlighter-rouge">cookie</code> 呢? 因此我开始了探究(先说结论: 我查看的资料的说法确实是正确的, 携带的确实是目标域 <code class="language-plaintext highlighter-rouge">b.com</code> 的 <code class="language-plaintext highlighter-rouge">cookie</code>).<h2 id="小目标-1-简单请求下让-acom-发送-ajax-到-bcom">小目标-1: 简单请求下让 <code class="language-plaintext highlighter-rouge">a.com</code> 发送 <code class="language-plaintext highlighter-rouge">ajax</code> 到 <code class="language-plaintext highlighter-rouge">b.com</code></h2><p>什么是简单请求请自行谷歌/SO. 这里注意一个基本事实, <code class="language-plaintext highlighter-rouge">cookie</code> 是跟随着 <code class="language-plaintext highlighter-rouge">域名</code> 的, 而不是跟随着 <code class="language-plaintext highlighter-rouge">IP地址</code>, 我在本地起了一个简单的能处理 <code class="language-plaintext highlighter-rouge">cookie</code> 的 <code class="language-plaintext highlighter-rouge">express</code> 服务, 同时在我的 <code class="language-plaintext highlighter-rouge">VPS</code> 上也起了一个相同的服务, 然后通过修改 <code class="language-plaintext highlighter-rouge">hosts</code> 来实现不同的域名:<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// 修改 hosts 如下</span>
<span class="c1">// 本机 ip</span>
<span class="mf">172.16</span><span class="p">.</span><span class="mf">26.57</span> <span class="nx">www</span><span class="p">.</span><span class="nx">a</span><span class="p">.</span><span class="nx">com</span>
<span class="c1">// VPS ip</span>
<span class="mf">45.78</span><span class="p">.</span><span class="mf">41.32</span> <span class="nx">www</span><span class="p">.</span><span class="nx">b</span><span class="p">.</span><span class="nx">com</span>
</code></pre></div></div><p>首先是在 <code class="language-plaintext highlighter-rouge">VPS</code> 服务器上启动一个 <code class="language-plaintext highlighter-rouge">express</code> 服务, 不设置任何东西, 只是简单的返回 <code class="language-plaintext highlighter-rouge">header</code>, 端口起在 <code class="language-plaintext highlighter-rouge">9091</code>:<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">var</span> <span class="nx">express</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">express</span><span class="dl">'</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">app</span> <span class="o">=</span> <span class="nx">express</span><span class="p">();</span>

<span class="nx">app</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="dl">'</span><span class="s1">/</span><span class="dl">'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">,</span> <span class="nx">next</span><span class="p">){</span>
  <span class="nx">res</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">headers</span><span class="p">);</span>
<span class="p">});</span>

<span class="nx">app</span><span class="p">.</span><span class="nx">listen</span><span class="p">(</span><span class="mi">9091</span><span class="p">);</span>
</code></pre></div></div><p><code class="language-plaintext highlighter-rouge">a.com</code> 的 <code class="language-plaintext highlighter-rouge">Server</code> 端基本一样, 只是加了个静态页为了发送 <code class="language-plaintext highlighter-rouge">ajax</code>, 端口起在 <code class="language-plaintext highlighter-rouge">9090</code>:<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">var</span> <span class="nx">express</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">express</span><span class="dl">'</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">app</span> <span class="o">=</span> <span class="nx">express</span><span class="p">();</span>
<span class="kd">var</span> <span class="nx">path</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">path</span><span class="dl">'</span><span class="p">);</span>
<span class="nx">app</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="dl">'</span><span class="s1">/</span><span class="dl">'</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">res</span><span class="p">.</span><span class="nx">sendFile</span><span class="p">(</span><span class="nx">path</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="nx">__dirname</span><span class="p">,</span> <span class="dl">'</span><span class="s1">index.html</span><span class="dl">'</span><span class="p">));</span>
<span class="p">});</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">listen</span><span class="p">(</span><span class="mi">9090</span><span class="p">);</span>
</code></pre></div></div><p><code class="language-plaintext highlighter-rouge">index.html</code> 内容:<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="nt">&lt;html&gt;</span>
<span class="nt">&lt;head&gt;</span>
  <span class="nt">&lt;title&gt;</span>a.com<span class="nt">&lt;/title&gt;</span>
<span class="nt">&lt;/head&gt;</span>
<span class="nt">&lt;body&gt;</span>
<span class="nt">&lt;button</span> <span class="na">id=</span><span class="s">"button"</span><span class="nt">&gt;</span>点我发请求, 打开控制台查看信息<span class="nt">&lt;/button&gt;</span>
<span class="nt">&lt;script </span><span class="na">type=</span><span class="s">"text/javascript"</span><span class="nt">&gt;</span>
<span class="kd">var</span> <span class="nx">button</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="dl">'</span><span class="s1">button</span><span class="dl">'</span><span class="p">);</span>

<span class="kd">function</span> <span class="nx">xhrSend</span><span class="p">(</span><span class="nx">e</span><span class="p">){</span>
  <span class="nx">e</span><span class="p">.</span><span class="nx">preventDefault</span><span class="p">();</span>
  <span class="kd">var</span> <span class="nx">xhr</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">XMLHttpRequest</span><span class="p">();</span>
  <span class="nx">xhr</span><span class="p">.</span><span class="nx">open</span><span class="p">(</span><span class="dl">'</span><span class="s1">GET</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">http://www.b.com:9091</span><span class="dl">'</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
  <span class="nx">xhr</span><span class="p">.</span><span class="nx">send</span><span class="p">();</span>
<span class="p">}</span>

<span class="nx">button</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="dl">'</span><span class="s1">click</span><span class="dl">'</span><span class="p">,</span> <span class="nx">xhrSend</span><span class="p">);</span>
<span class="nt">&lt;/script&gt;</span>
<span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</code></pre></div></div><p>因为服务端没有设置 <code class="language-plaintext highlighter-rouge">Access-Control-Allow-Origin</code>, 因此报错:<p><img src="https://cdn.jsdelivr.net/gh/xheldon/x_blog-static@master/img/2016/VPSServerError.png" alt="VPSServerError" title="VPSServerError" /><p>接下来在 <code class="language-plaintext highlighter-rouge">b.com</code> 的服务端加上允许来自 <code class="language-plaintext highlighter-rouge">a.com</code> 的 <code class="language-plaintext highlighter-rouge">ajax</code>(需要精确到端口):<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">app</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="dl">'</span><span class="s1">/</span><span class="dl">'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">,</span> <span class="nx">next</span><span class="p">){</span>
  <span class="nx">res</span><span class="p">.</span><span class="kd">set</span><span class="p">({</span>
    <span class="dl">'</span><span class="s1">Access-Control-Allow-Origin</span><span class="dl">'</span><span class="p">:</span> <span class="dl">'</span><span class="s1">http://www.a.com:9090</span><span class="dl">'</span>
  <span class="p">});</span>
  <span class="nx">res</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">headers</span><span class="p">);</span>
<span class="p">});</span>
</code></pre></div></div><p>再次发起请求:<p><img src="https://cdn.jsdelivr.net/gh/xheldon/x_blog-static@master/img/2016/VPSServerError1.png" alt="VPSServerError1" title="VPSServerError1" /><p><img src="https://cdn.jsdelivr.net/gh/xheldon/x_blog-static@master/img/2016/VPSServerError1.1.png" alt="VPSServerError1.1" title="VPSServerError1.1" /><p>控制台没有报错, 而且状态码为 <code class="language-plaintext highlighter-rouge">200</code> 说明 <code class="language-plaintext highlighter-rouge">b.com</code> 已经允许来自 <code class="language-plaintext highlighter-rouge">a.com:9090</code> 的请求.<h2 id="小目标-2-本地服务接收前端的-cookie">小目标-2: 本地服务接收前端的 <code class="language-plaintext highlighter-rouge">cookie</code></h2><p>接下来我们先在本地测试下 <code class="language-plaintext highlighter-rouge">a.com</code> 后端能否获取到来自前端的 <code class="language-plaintext highlighter-rouge">cookie</code>:<p>测试方法很简单, 随便加点 <code class="language-plaintext highlighter-rouge">cookie</code> 在 <code class="language-plaintext highlighter-rouge">js</code> 中即可:<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">document</span><span class="p">.</span><span class="nx">cookie</span> <span class="o">=</span> <span class="dl">'</span><span class="s1">domain=a.com;</span><span class="dl">'</span><span class="p">;</span>
<span class="nb">document</span><span class="p">.</span><span class="nx">cookie</span> <span class="o">=</span> <span class="dl">'</span><span class="s1">name=xheldon</span><span class="dl">'</span><span class="p">;</span>
<span class="nb">document</span><span class="p">.</span><span class="nx">cookie</span> <span class="o">=</span> <span class="dl">'</span><span class="s1">lover=xiaodan</span><span class="dl">'</span><span class="p">;</span>
</code></pre></div></div><p><img src="https://cdn.jsdelivr.net/gh/xheldon/x_blog-static@master/img/2016/LocalServer1.png" alt="LocalServer1" title="LocalServer1" /><p>在本地控制台的 <code class="language-plaintext highlighter-rouge">Application</code> 选项卡可以看到已经有了 <code class="language-plaintext highlighter-rouge">cookie</code>, 再看看后端输出:<p><img src="https://cdn.jsdelivr.net/gh/xheldon/x_blog-static@master/img/2016/LocalServer2.png" alt="LocalServer2" title="LocalServer2" /><p>OK 没毛病, 访问 <code class="language-plaintext highlighter-rouge">www.a.com:9090</code> 的时候确实带上了 <code class="language-plaintext highlighter-rouge">cookie</code>, 意料之中.<h2 id="小目标-3-把-acom-的-cookie-发送到-bcom">小目标-3: 把 <code class="language-plaintext highlighter-rouge">a.com</code> 的 <code class="language-plaintext highlighter-rouge">cookie</code> 发送到 <code class="language-plaintext highlighter-rouge">b.com</code></h2><p>这个时候 <code class="language-plaintext highlighter-rouge">a.com</code> 的页面是有 <code class="language-plaintext highlighter-rouge">cookie</code> 的, 因此我们再次点击按钮, 看 <code class="language-plaintext highlighter-rouge">ajax</code> 请求能否把 <code class="language-plaintext highlighter-rouge">cookie</code> 传递给 <code class="language-plaintext highlighter-rouge">b.com</code>:<p><img src="https://cdn.jsdelivr.net/gh/xheldon/x_blog-static@master/img/2016/VPSServerError1.2.png" alt="VPSServerError1.2" title="VPSServerError1.2" /><p>和没有加 <code class="language-plaintext highlighter-rouge">cookie</code> 一样, 并没有获取到来自 <code class="language-plaintext highlighter-rouge">a.com</code> 的 <code class="language-plaintext highlighter-rouge">cookie</code>, 这当然是因为安全限制, 也是意料之中.<h2 id="额外定一个小目标-非简单请求">额外定一个小目标: 非简单请求</h2><p>此处插播一个关于简单请求的测试, 在 <code class="language-plaintext highlighter-rouge">xhr</code> 中新增一个 <code class="language-plaintext highlighter-rouge">header</code>, 之后再发请求:<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">function</span> <span class="nx">xhrSend</span><span class="p">(</span><span class="nx">e</span><span class="p">){</span>
  <span class="nx">e</span><span class="p">.</span><span class="nx">preventDefault</span><span class="p">();</span>
  <span class="kd">var</span> <span class="nx">xhr</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">XMLHttpRequest</span><span class="p">();</span>
  <span class="nx">xhr</span><span class="p">.</span><span class="nx">open</span><span class="p">(</span><span class="dl">'</span><span class="s1">GET</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">http://www.b.com:9091</span><span class="dl">'</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
  <span class="nx">xhr</span><span class="p">.</span><span class="nx">setRequestHeader</span><span class="p">(</span><span class="dl">'</span><span class="s1">xiaodan</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">xheldon</span><span class="dl">'</span><span class="p">);</span>
    <span class="nx">xhr</span><span class="p">.</span><span class="nx">send</span><span class="p">();</span>
  <span class="p">}</span>
</code></pre></div></div><p>因为这次是在加了 <code class="language-plaintext highlighter-rouge">Access-Control-Allow-Origin</code> 之后的操作, 因此这次浏览器报了个不一样的错误:<p><img src="https://cdn.jsdelivr.net/gh/xheldon/x_blog-static@master/img/2016/VPSServerError2.1.png" alt="VPSServerError2.1" title="VPSServerError2.1" /><p>注意到还是因为 <code class="language-plaintext highlighter-rouge">Access-Control-Allow-Origin</code> 的错误, 但是这次是因为前端设置了一个自定义的 <code class="language-plaintext highlighter-rouge">header</code>, 因此是一个非简单请求, 对于非简单请求会先发一个预检请求(<code class="language-plaintext highlighter-rouge">prelight</code>), 请求类型是 <code class="language-plaintext highlighter-rouge">OPTIONS</code>, 可以查看 <a href="http://harttle.com/2016/12/30/cors-preflight.html">这篇文章</a> 了解更多. 预检请求目的是嘘寒问暖 <code class="language-plaintext highlighter-rouge">b.com</code> 的服务器, 是否接受这个 <code class="language-plaintext highlighter-rouge">xiaodan</code> 的 <code class="language-plaintext highlighter-rouge">header</code>, 后端在返回的 <code class="language-plaintext highlighter-rouge">header</code> <code class="language-plaintext highlighter-rouge">Access-Control-Alow-Headers</code> 中, 没有这个叫做 <code class="language-plaintext highlighter-rouge">xiaodan</code> 的值, 因此报错.<p>那接下来我们把 <code class="language-plaintext highlighter-rouge">b.com</code> 返回的内容加上 相应的 <code class="language-plaintext highlighter-rouge">header</code>:<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">app</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="dl">'</span><span class="s1">/</span><span class="dl">'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">,</span> <span class="nx">next</span><span class="p">){</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">headers</span><span class="p">);</span>
  <span class="nx">res</span><span class="p">.</span><span class="kd">set</span><span class="p">({</span>
    <span class="dl">'</span><span class="s1">Access-Control-Allow-Origin</span><span class="dl">'</span><span class="p">:</span> <span class="dl">'</span><span class="s1">http://www.a.com:9090</span><span class="dl">'</span><span class="p">,</span>
    <span class="dl">'</span><span class="s1">Access-Control-Allow-Headers</span><span class="dl">'</span><span class="p">:</span> <span class="dl">'</span><span class="s1">xiaodan</span><span class="dl">'</span>
  <span class="p">});</span>
  <span class="nx">res</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">headers</span><span class="p">);</span>
<span class="p">});</span>
</code></pre></div></div><p>再次发起请求看看:<p><img src="https://cdn.jsdelivr.net/gh/xheldon/x_blog-static@master/img/2016/VPSServerError2.1.png" alt="VPSServerError2.1" title="VPSServerError2.1" /><p>居然是一样的报错结果, 虽然响应了 <code class="language-plaintext highlighter-rouge">200</code>, 但是服务端没有返回相应的 <code class="language-plaintext highlighter-rouge">Access-Control-Allow-Headers</code>, 返回结果被浏览器拒绝了(注意不是被服务器拒绝, 服务器是返回了 <code class="language-plaintext highlighter-rouge">200</code> 的).<p>排查了一下发现, 问题出在这个非简单请求上面, 我把 <code class="language-plaintext highlighter-rouge">b.com</code> 函数稍微修改下:<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">,</span> <span class="nx">next</span><span class="p">){</span>
  <span class="nx">res</span><span class="p">.</span><span class="kd">set</span><span class="p">({</span>
    <span class="dl">'</span><span class="s1">Access-Control-Allow-Origin</span><span class="dl">'</span><span class="p">:</span> <span class="dl">'</span><span class="s1">http://www.a.com:9090</span><span class="dl">'</span><span class="p">,</span>
    <span class="dl">'</span><span class="s1">Access-Control-Allow-Headers</span><span class="dl">'</span><span class="p">:</span> <span class="dl">'</span><span class="s1">xiaodan</span><span class="dl">'</span>
  <span class="p">});</span>
  <span class="nx">next</span><span class="p">();</span>
<span class="p">});</span>

<span class="nx">app</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="dl">'</span><span class="s1">/</span><span class="dl">'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">,</span> <span class="nx">next</span><span class="p">){</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">headers</span><span class="p">);</span>
  <span class="nx">res</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">headers</span><span class="p">);</span>
<span class="p">});</span>
</code></pre></div></div><p>服务端:<p><img src="https://cdn.jsdelivr.net/gh/xheldon/x_blog-static@master/img/2016/VPSServerError2.2.png" alt="VPSServerError2.2" title="VPSServerError2.2" /><p>客户端:<p><img src="https://cdn.jsdelivr.net/gh/xheldon/x_blog-static@master/img/2016/VPSServerError2.3.png" alt="VPSServerError2.3" title="VPSServerError2.3" /><p>分析原因在于(待求证, 回头翻翻 <code class="language-plaintext highlighter-rouge">HTTP</code> 权威指南再说), 非简单请求的 <code class="language-plaintext highlighter-rouge">prelight</code> 请求, 不会发起实际请求, 而是先发送一个预检请求, 来测试服务器是否支持某个非简单 <code class="language-plaintext highlighter-rouge">header</code> 字段, 也就是说, 带有非简单头部的请求不会走到 <code class="language-plaintext highlighter-rouge">app.get('/')</code> 里面. 同时可以在 <code class="language-plaintext highlighter-rouge">b.com</code> 的服务器看到, 因为 <code class="language-plaintext highlighter-rouge">console.log(req.headers)</code> 是写在 <code class="language-plaintext highlighter-rouge">app.get('/')</code> 里面的, 刚刚的请求 <code class="language-plaintext highlighter-rouge">b.com</code> 服务器并没有输出任何东西, 因此也印证了这一点. <code class="language-plaintext highlighter-rouge">这一设计旨在确保服务器对 CORS 标准知情，以保护不支持 CORS 的旧服务器</code>.<h2 id="小目标-4-把-acom-域下的-cookie-发送到-bcom">小目标-4: 把 <code class="language-plaintext highlighter-rouge">a.com</code> 域下的 <code class="language-plaintext highlighter-rouge">cookie</code> 发送到 <code class="language-plaintext highlighter-rouge">b.com</code></h2><p>OK, 插播结束, 我们来测试下在客户端, 也即 <code class="language-plaintext highlighter-rouge">a.com</code> 下发起的 <code class="language-plaintext highlighter-rouge">xhr</code> 请求的页面设置 <code class="language-plaintext highlighter-rouge">withCredentials = true</code> (只列出 <code class="language-plaintext highlighter-rouge">xhrSend</code> 部分)能否将 <code class="language-plaintext highlighter-rouge">a.com</code> 的 <code class="language-plaintext highlighter-rouge">cookie</code> 发送到 <code class="language-plaintext highlighter-rouge">b.com</code>(这里简单请求和非简单请求是一样的结果, 为了方便查看差异我把 <code class="language-plaintext highlighter-rouge">xhr</code> 设置的 <code class="language-plaintext highlighter-rouge">header</code> 去掉了):<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// 设置允许 cookie</span>
<span class="kd">function</span> <span class="nx">xhrSend</span><span class="p">(</span><span class="nx">e</span><span class="p">){</span>
  <span class="nx">e</span><span class="p">.</span><span class="nx">preventDefault</span><span class="p">();</span>
  <span class="kd">var</span> <span class="nx">xhr</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">XMLHttpRequest</span><span class="p">();</span>
  <span class="nx">xhr</span><span class="p">.</span><span class="nx">open</span><span class="p">(</span><span class="dl">'</span><span class="s1">GET</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">http://www.b.com/</span><span class="dl">'</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
  <span class="nx">xhr</span><span class="p">.</span><span class="nx">withCredentials</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
  <span class="nx">xhr</span><span class="p">.</span><span class="nx">send</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></div></div><p><img src="https://cdn.jsdelivr.net/gh/xheldon/x_blog-static@master/img/2016/VPSServerError2.4.png" alt="VPSServerError2.4" title="VPSServerError2.4" /><p>这次错误提醒变化, 变成服务端没有设置 <code class="language-plaintext highlighter-rouge">Access-Control-Allow-Credentials</code> 为 <code class="language-plaintext highlighter-rouge">true</code> 了, 这个 <code class="language-plaintext highlighter-rouge">header</code> 是来设置允许请求携带 <code class="language-plaintext highlighter-rouge">cookie</code> 的, 因此设置一下:<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span><span class="nx">res</span><span class="p">,</span> <span class="nx">next</span><span class="p">){</span>
  <span class="nx">res</span><span class="p">.</span><span class="kd">set</span><span class="p">({</span>
    <span class="dl">'</span><span class="s1">Access-Control-Allow-Origin</span><span class="dl">'</span><span class="p">:</span><span class="dl">'</span><span class="s1">http://www.a.com:9090</span><span class="dl">'</span><span class="p">,</span>
    <span class="dl">'</span><span class="s1">Access-Control-Allow-Headers</span><span class="dl">'</span><span class="p">:</span> <span class="dl">'</span><span class="s1">xiaodan</span><span class="dl">'</span><span class="p">,</span>
    <span class="dl">'</span><span class="s1">Access-Control-Allow-Credentials</span><span class="dl">'</span><span class="p">:</span> <span class="kc">true</span>
  <span class="p">});</span>
  <span class="nx">next</span><span class="p">();</span>
<span class="p">});</span>

<span class="nx">app</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="dl">'</span><span class="s1">/</span><span class="dl">'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">,</span> <span class="nx">next</span><span class="p">){</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">headers</span><span class="p">);</span>
  <span class="nx">res</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">headers</span><span class="p">);</span>
<span class="p">});</span>
</code></pre></div></div><p><img src="https://cdn.jsdelivr.net/gh/xheldon/x_blog-static@master/img/2016/VPSServerError2.5.png" alt="VPSServerError2.5" title="VPSServerError2.5" /><p>仍然没有, 看下 <code class="language-plaintext highlighter-rouge">Chrome</code> 的 <code class="language-plaintext highlighter-rouge">cookie</code>:<p><img src="https://cdn.jsdelivr.net/gh/xheldon/x_blog-static@master/img/2016/VPSServerError2.6.png" alt="VPSServerError2.6" title="VPSServerError2.6" /><p>确实是设置了 <code class="language-plaintext highlighter-rouge">cookie</code> 啊, 什么情况? 不服, 想着 <code class="language-plaintext highlighter-rouge">req.headers</code> 是 <code class="language-plaintext highlighter-rouge">express</code> 格式化之后的, 看看原始 <code class="language-plaintext highlighter-rouge">headers</code> <code class="language-plaintext highlighter-rouge">rawHeaders</code>:<p><img src="https://cdn.jsdelivr.net/gh/xheldon/x_blog-static@master/img/2016/VPSServerError2.7.png" alt="VPSServerError2.7" title="VPSServerError2.7" /><p>还是没看到, <code class="language-plaintext highlighter-rouge">cookie</code> 被狗吃了吗?<blockquote><p>都没有, 她说将来会找到, 时间,时间会给我答案 ——我的滑板鞋</blockquote><p>OK, 找不到问题的时候就吃个冰淇淋吧. 下楼买了个香菜味的雀巢冰激凌(吃不起哈根达斯), 然后在上楼的时候灵光一闪, 好像我们这个属于是第三方 <code class="language-plaintext highlighter-rouge">cookie</code>, 会不会是我禁止浏览器追踪导致的呢? 于是吃完冰激凌我在 <code class="language-plaintext highlighter-rouge">chrome</code> 的设置中, 把 <code class="language-plaintext highlighter-rouge">随浏览流量一起发送"不跟踪"请求</code> 的钩钩给去掉了:<p><img src="https://cdn.jsdelivr.net/gh/xheldon/x_blog-static@master/img/2016/VPSServerError2.8.png" alt="VPSServerError2.8" title="VPSServerError2.8" /><p>对了, 这次我把 <code class="language-plaintext highlighter-rouge">req.headers</code> 放到了 <code class="language-plaintext highlighter-rouge">app.use</code> 里面以防万一(其实不会有什么万一)：<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span><span class="nx">res</span><span class="p">,</span> <span class="nx">next</span><span class="p">){</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">headers</span><span class="p">);</span>
  <span class="nx">res</span><span class="p">.</span><span class="kd">set</span><span class="p">({</span>
    <span class="dl">'</span><span class="s1">Access-Control-Allow-Origin</span><span class="dl">'</span><span class="p">:</span><span class="dl">'</span><span class="s1">http://www.a.com:9090</span><span class="dl">'</span><span class="p">,</span>
    <span class="dl">'</span><span class="s1">Access-Control-Allow-Headers</span><span class="dl">'</span><span class="p">:</span> <span class="dl">'</span><span class="s1">xiaodan</span><span class="dl">'</span><span class="p">,</span>
    <span class="dl">'</span><span class="s1">Access-Control-Allow-Credentials</span><span class="dl">'</span><span class="p">:</span> <span class="kc">true</span>
  <span class="p">});</span>
  <span class="nx">next</span><span class="p">();</span>
<span class="p">});</span>

<span class="nx">app</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="dl">'</span><span class="s1">/</span><span class="dl">'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">,</span> <span class="nx">next</span><span class="p">){</span>
  <span class="nx">res</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">headers</span><span class="p">);</span>
<span class="p">});</span>
</code></pre></div></div><p>再次点击按钮发送请求, 然后查看 <code class="language-plaintext highlighter-rouge">chrome</code> 控制台和 <code class="language-plaintext highlighter-rouge">b.com</code> 的服务器输出:<p>因为有非简单头部, 因此和之前一样, 显示的是两个请求:<p><img src="https://cdn.jsdelivr.net/gh/xheldon/x_blog-static@master/img/2016/VPSServerError2.9.png" alt="VPSServerError2.9" title="VPSServerError2.9" /><p><img src="https://cdn.jsdelivr.net/gh/xheldon/x_blog-static@master/img/2016/VPSServerError2.9.1.png" alt="VPSServerError2.9.1" title="VPSServerError2.9.1" /><p>服务器也没有接收到, 说明和这个 <code class="language-plaintext highlighter-rouge">Chrome</code> 设置无关, 因此为了控制变量 <code class="language-plaintext highlighter-rouge">不跟踪</code> 和之前一样, 我把它又钩上了, 服务器端(只放了 <code class="language-plaintext highlighter-rouge">GET</code> 请求):<p><img src="https://cdn.jsdelivr.net/gh/xheldon/x_blog-static@master/img/2016/VPSServerError2.9.2.png" alt="VPSServerError2.9.2" title="VPSServerError2.9.2" /><p>还是没有 <code class="language-plaintext highlighter-rouge">Cookie</code> 字段, 为什么呢?<p>我又想起了文章开头的那句话: ‘注意, 设置了 <code class="language-plaintext highlighter-rouge">withCredentials = true</code> 之后, 携带的 <code class="language-plaintext highlighter-rouge">cookie</code> 是目标域的 <code class="language-plaintext highlighter-rouge">cookie</code>’. 难道我在 <code class="language-plaintext highlighter-rouge">a.com</code> 点击按钮发送请求到 <code class="language-plaintext highlighter-rouge">b.com</code>, 发送的是 <code class="language-plaintext highlighter-rouge">b.com</code> 设置的 <code class="language-plaintext highlighter-rouge">cookie</code> 吗?<p>于是我先把 <code class="language-plaintext highlighter-rouge">b.com</code> 服务器上也新建一个 <code class="language-plaintext highlighter-rouge">index.html</code>, 里面随便加点 <code class="language-plaintext highlighter-rouge">cookie</code>:<p><code class="language-plaintext highlighter-rouge">b.com</code> 的服务器代码:<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">var</span> <span class="nx">express</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">express</span><span class="dl">'</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">app</span> <span class="o">=</span> <span class="nx">express</span><span class="p">();</span>
<span class="kd">var</span> <span class="nx">path</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">path</span><span class="dl">'</span><span class="p">);</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span><span class="nx">res</span><span class="p">,</span> <span class="nx">next</span><span class="p">){</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">headers</span><span class="p">);</span>
<span class="nx">res</span><span class="p">.</span><span class="kd">set</span><span class="p">({</span>
  <span class="dl">'</span><span class="s1">Access-Control-Allow-Origin</span><span class="dl">'</span><span class="p">:</span><span class="dl">'</span><span class="s1">http://www.a.com:9090</span><span class="dl">'</span><span class="p">,</span>
  <span class="dl">'</span><span class="s1">Access-Control-Allow-Headers</span><span class="dl">'</span><span class="p">:</span> <span class="dl">'</span><span class="s1">xiaodan</span><span class="dl">'</span><span class="p">,</span>
  <span class="dl">'</span><span class="s1">Access-Control-Allow-Credentials</span><span class="dl">'</span><span class="p">:</span> <span class="kc">true</span>
<span class="p">});</span>
<span class="nx">next</span><span class="p">();</span>
<span class="p">});</span>

<span class="nx">app</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="dl">'</span><span class="s1">/</span><span class="dl">'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">,</span> <span class="nx">next</span><span class="p">){</span>
  <span class="nx">res</span><span class="p">.</span><span class="nx">sendFile</span><span class="p">(</span><span class="nx">path</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="nx">__dirname</span><span class="p">,</span> <span class="dl">'</span><span class="s1">index.html</span><span class="dl">'</span><span class="p">));</span>
<span class="p">});</span>

<span class="nx">app</span><span class="p">.</span><span class="nx">listen</span><span class="p">(</span><span class="mi">9091</span><span class="p">);</span>
</code></pre></div></div><p>b.com 的 index.html 代码:<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="nt">&lt;html&gt;</span>
<span class="nt">&lt;head&gt;</span>
  <span class="nt">&lt;title&gt;</span>a.com<span class="nt">&lt;/title&gt;</span>
<span class="nt">&lt;/head&gt;</span>
<span class="nt">&lt;body&gt;</span>
<span class="nt">&lt;div&gt;</span>open Application inspector to check whether the cookie is be setting<span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;script </span><span class="na">type=</span><span class="s">"text/javascript"</span><span class="nt">&gt;</span>
    <span class="nb">document</span><span class="p">.</span><span class="nx">cookie</span> <span class="o">=</span> <span class="dl">'</span><span class="s1">yes=you_cant_believe_i_from_b.com</span><span class="dl">'</span>
    <span class="nb">document</span><span class="p">.</span><span class="nx">cookie</span> <span class="o">=</span> <span class="dl">'</span><span class="s1">from=this_is_from_b.com</span><span class="dl">'</span>
<span class="nt">&lt;/script&gt;</span>
<span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</code></pre></div></div><p>OK, 我们首先访问 <code class="language-plaintext highlighter-rouge">b.com</code>:<p><img src="https://cdn.jsdelivr.net/gh/xheldon/x_blog-static@master/img/2016/VPSServerError4.png" alt="VPSServerError4" title="VPSServerError4" /><p>没毛病, 正常返回网页, 正常设置 <code class="language-plaintext highlighter-rouge">cookie</code>, 接下来我们在 <code class="language-plaintext highlighter-rouge">a.com</code> 下, 点击按钮发送请求:<p><img src="https://cdn.jsdelivr.net/gh/xheldon/x_blog-static@master/img/2016/VPSServerError4.1.png" alt="VPSServerError4.1" title="VPSServerError4.1" /><p>可以看到在 <code class="language-plaintext highlighter-rouge">a.com</code> 发起的 <code class="language-plaintext highlighter-rouge">ajax</code> 请求, 带上了 <code class="language-plaintext highlighter-rouge">b.com</code> 的 <code class="language-plaintext highlighter-rouge">cookie</code>.<p>文章开始的那句话得到了证实.<h2 id="小目标-5-acom-的-javascript-获取-bcom-的-cookie">小目标-5: <code class="language-plaintext highlighter-rouge">a.com</code> 的 <code class="language-plaintext highlighter-rouge">JavaScript</code> 获取 <code class="language-plaintext highlighter-rouge">b.com</code> 的 <code class="language-plaintext highlighter-rouge">cookie</code>:</h2><p>既然能在 <code class="language-plaintext highlighter-rouge">a.com</code> 发送 <code class="language-plaintext highlighter-rouge">b.com</code> 的 <code class="language-plaintext highlighter-rouge">cookie</code>, 那么前端能不能获取到 <code class="language-plaintext highlighter-rouge">b.com</code> 的 <code class="language-plaintext highlighter-rouge">cookie</code> 呢?<p>看了下文档, <code class="language-plaintext highlighter-rouge">ajax</code> 有 <code class="language-plaintext highlighter-rouge">getAllResponseHeaders()</code> 和 <code class="language-plaintext highlighter-rouge">getResponseHeader()</code>两个接口, 服务端有 <code class="language-plaintext highlighter-rouge">Access-Control-Expose-Header</code>, 于是我测试了下(我就是要分开输出, 怎样?).<p>先从简单的来, 首先是调用 <code class="language-plaintext highlighter-rouge">xhr</code> 的 <code class="language-plaintext highlighter-rouge">getAllResponseHeaders()</code> 接口:<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// 设置允许 cookie</span>
<span class="kd">function</span> <span class="nx">xhrSend</span><span class="p">(</span><span class="nx">e</span><span class="p">){</span>
  <span class="nx">e</span><span class="p">.</span><span class="nx">preventDefault</span><span class="p">();</span>
  <span class="kd">var</span> <span class="nx">xhr</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">XMLHttpRequest</span><span class="p">();</span>
  <span class="nx">xhr</span><span class="p">.</span><span class="nx">open</span><span class="p">(</span><span class="dl">'</span><span class="s1">GET</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">http://www.b.com/</span><span class="dl">'</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
  <span class="nx">xhr</span><span class="p">.</span><span class="nx">withCredentials</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
  <span class="nx">xhr</span><span class="p">.</span><span class="nx">onreadystatechange</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(){</span>
    <span class="k">if</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">status</span> <span class="o">===</span> <span class="mi">200</span><span class="p">){</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">'</span><span class="s1">AllRes:</span><span class="dl">'</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">getAllResponseHeaders</span><span class="p">())</span>
    <span class="p">}</span>
  <span class="p">};</span>
  <span class="nx">xhr</span><span class="p">.</span><span class="nx">send</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></div></div><p><img src="https://cdn.jsdelivr.net/gh/xheldon/x_blog-static@master/img/2016/LocalServer3.png" alt="LocalServer3" title="LocalServer3" /><p>发现并没有出现 <code class="language-plaintext highlighter-rouge">header</code> 的 <code class="language-plaintext highlighter-rouge">Cookie</code> 字段, 意料之中, 想着万一 <code class="language-plaintext highlighter-rouge">getAllResponseHeaders()</code> 遍历 <code class="language-plaintext highlighter-rouge">header</code> 的没有 <code class="language-plaintext highlighter-rouge">Cookie</code> 是因为其被设置成 <code class="language-plaintext highlighter-rouge">enumerable: false</code> 了呢? 于是我又尝试了 <code class="language-plaintext highlighter-rouge">getResponseHeader()</code>:<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// 设置允许 cookie</span>
<span class="kd">function</span> <span class="nx">xhrSend</span><span class="p">(</span><span class="nx">e</span><span class="p">){</span>
  <span class="nx">e</span><span class="p">.</span><span class="nx">preventDefault</span><span class="p">();</span>
  <span class="kd">var</span> <span class="nx">xhr</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">XMLHttpRequest</span><span class="p">();</span>
  <span class="nx">xhr</span><span class="p">.</span><span class="nx">open</span><span class="p">(</span><span class="dl">'</span><span class="s1">GET</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">http://www.b.com/</span><span class="dl">'</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
  <span class="nx">xhr</span><span class="p">.</span><span class="nx">withCredentials</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
  <span class="nx">xhr</span><span class="p">.</span><span class="nx">onreadystatechange</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(){</span>
    <span class="k">if</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">status</span> <span class="o">===</span> <span class="mi">200</span><span class="p">){</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">'</span><span class="s1">Res:</span><span class="dl">'</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">getResponseHeader</span><span class="p">(</span><span class="dl">'</span><span class="s1">Cookie</span><span class="dl">'</span><span class="p">))</span>
    <span class="p">}</span>
  <span class="p">};</span>
  <span class="nx">xhr</span><span class="p">.</span><span class="nx">send</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></div></div><p><img src="https://cdn.jsdelivr.net/gh/xheldon/x_blog-static@master/img/2016/LocalServer3.1.png" alt="LocalServer3.1" title="LocalServer3.1" /><p>还是意料之中, 因为服务端没有设置暴露出来的 <code class="language-plaintext highlighter-rouge">header</code> 内容, 于是我在 <code class="language-plaintext highlighter-rouge">b.com</code> 设置了 <code class="language-plaintext highlighter-rouge">Access-Control-Expose-Header</code>:<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">res</span><span class="p">.</span><span class="kd">set</span><span class="p">({</span>
  <span class="dl">'</span><span class="s1">Access-Control-Allow-Origin</span><span class="dl">'</span><span class="p">:</span><span class="dl">'</span><span class="s1">http://www.a.com:9090</span><span class="dl">'</span><span class="p">,</span>
  <span class="dl">'</span><span class="s1">Access-Control-Allow-Headers</span><span class="dl">'</span><span class="p">:</span> <span class="dl">'</span><span class="s1">xiaodan</span><span class="dl">'</span><span class="p">,</span>
  <span class="dl">'</span><span class="s1">Access-Control-Allow-Credentials</span><span class="dl">'</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
  <span class="dl">'</span><span class="s1">Access-Control-Expose-Headers</span><span class="dl">'</span><span class="p">:</span> <span class="dl">'</span><span class="s1">Cookie</span><span class="dl">'</span>
<span class="p">});</span>
</code></pre></div></div><p>然后重新执行 <code class="language-plaintext highlighter-rouge">getResponseHeader('Cookie')</code> 和 <code class="language-plaintext highlighter-rouge">getAllResponseHeaders()</code><p><img src="https://cdn.jsdelivr.net/gh/xheldon/x_blog-static@master/img/2016/LocalServer3.2.png" alt="LocalServer3.2" title="LocalServer3.2" /><p>没有错误了, 但是还是无法获取到 <code class="language-plaintext highlighter-rouge">b.com</code> 的 <code class="language-plaintext highlighter-rouge">cookie</code>, 即使 <code class="language-plaintext highlighter-rouge">b.com</code> 服务端都同意了也不行.<p>查找资料得知, 这个 <code class="language-plaintext highlighter-rouge">Access-Control-Expose-Header</code> 只能设置为自定义的 <code class="language-plaintext highlighter-rouge">header</code> 来被前端获得. 但是这个没什么意义啊, 因为这个自定义的 <code class="language-plaintext highlighter-rouge">header</code> 就是我前端设置的, 唯一的作用就是 后端修改/新建自定义的 <code class="language-plaintext highlighter-rouge">header</code> 之后, 前端来获取. 下面我在后端设置一个 <code class="language-plaintext highlighter-rouge">header</code>, 让前端来获取:<p><code class="language-plaintext highlighter-rouge">b.com</code> 的 <code class="language-plaintext highlighter-rouge">server</code>:<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">res</span><span class="p">.</span><span class="kd">set</span><span class="p">({</span>
  <span class="dl">'</span><span class="s1">Access-Control-Allow-Origin</span><span class="dl">'</span><span class="p">:</span><span class="dl">'</span><span class="s1">http://www.a.com:9090</span><span class="dl">'</span><span class="p">,</span>
  <span class="dl">'</span><span class="s1">Access-Control-Allow-Headers</span><span class="dl">'</span><span class="p">:</span> <span class="dl">'</span><span class="s1">xiaodan</span><span class="dl">'</span><span class="p">,</span>
  <span class="dl">'</span><span class="s1">Access-Control-Allow-Credentials</span><span class="dl">'</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
  <span class="dl">'</span><span class="s1">Access-Control-Expose-Headers</span><span class="dl">'</span><span class="p">:</span> <span class="dl">'</span><span class="s1">Xheldon</span><span class="dl">'</span><span class="p">,</span>
  <span class="dl">'</span><span class="s1">Xheldon</span><span class="dl">'</span><span class="p">:</span> <span class="dl">'</span><span class="s1">MyNameIsXheldon</span><span class="dl">'</span>
<span class="p">});</span>
</code></pre></div></div><p><code class="language-plaintext highlighter-rouge">a.com</code> 的 <code class="language-plaintext highlighter-rouge">index.html</code>:<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">xhr</span><span class="p">.</span><span class="nx">onreadystatechange</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(){</span>
  <span class="k">if</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">status</span> <span class="o">===</span> <span class="mi">200</span><span class="p">){</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">'</span><span class="s1">Res:</span><span class="dl">'</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">getResponseHeader</span><span class="p">(</span><span class="dl">'</span><span class="s1">Xheldon</span><span class="dl">'</span><span class="p">));</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">'</span><span class="s1">AllRes:</span><span class="dl">'</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">getAllResponseHeaders</span><span class="p">());</span>
  <span class="p">}</span>
<span class="p">};</span>
</code></pre></div></div><p><img src="https://cdn.jsdelivr.net/gh/xheldon/x_blog-static@master/img/2016/LocalServer3.3.png" alt="LocalServer3.3" title="LocalServer3.3" /><p>就是这样.<p>所以这个小目标是实现不了了, 但是 <code class="language-plaintext highlighter-rouge">SO</code> 社区给出了一些解决办法, 比如 使用第三方服务/后端做转发 等, 毕竟规定是死的, 人是活的, 就像 <code class="language-plaintext highlighter-rouge">jsonp</code> 一样, 是吧.<h2 id="联想">联想</h2><p>有人说培训几个月零基础就可以精通某种语言, 我觉得是天方夜谭. 因为在没有计算机基础知识的情况下, 在搞不清二进制/编译原理/计算机原理/操作系统原理/网络基础/通讯协议的是什么概念的情况下能写出代码, 只能说明你照葫芦画瓢的学习能力强, 你知道这么写是这么个效, 但是你不知道为什么这么写就会出现这么个效果.<p>因此在跟计算机打交道的时候, 知识面是越广越好, 知识深度是越深越好. 这不, 我在了解 CORS 的时候, 想起了之前接触过的 AUTH.<p>有个叫 <code class="language-plaintext highlighter-rouge">AUTH2.0</code> 的东西, 那它跟 <code class="language-plaintext highlighter-rouge">CORS</code> 有什么关系呢? 没啥关系, 不过下面是我的对比:<p><code class="language-plaintext highlighter-rouge">CORS</code>, 可以让访问过 <code class="language-plaintext highlighter-rouge">B</code> 站的用户, 从 <code class="language-plaintext highlighter-rouge">A</code> 站发起请求的时候, 携带 <code class="language-plaintext highlighter-rouge">B</code> 站的 <code class="language-plaintext highlighter-rouge">cookie</code>. 步骤是:<ol><li>用户访问过 <code class="language-plaintext highlighter-rouge">B</code> 站.<li>用户访问 <code class="language-plaintext highlighter-rouge">A</code> 站, 在 <code class="language-plaintext highlighter-rouge">A</code> 站发起请求到 <code class="language-plaintext highlighter-rouge">B</code> 站.<li><code class="language-plaintext highlighter-rouge">B</code> 站验证来自 <code class="language-plaintext highlighter-rouge">A</code> 站的请求中的来自 <code class="language-plaintext highlighter-rouge">B</code> 站的 <code class="language-plaintext highlighter-rouge">cookie</code>, 没毛病, 返回 <code class="language-plaintext highlighter-rouge">B</code> 站的数据.</ol><p><code class="language-plaintext highlighter-rouge">AUTH</code>, 可以让用户在 <code class="language-plaintext highlighter-rouge">A</code> 网站访问 <code class="language-plaintext highlighter-rouge">B</code> 网站的资源. 前提是需要用户授权, 步骤是:<ol><li>在 <code class="language-plaintext highlighter-rouge">A</code> 网站发起请求.<li>步骤1跳转到 <code class="language-plaintext highlighter-rouge">B</code> 站, 确认授权, 再跳转回 <code class="language-plaintext highlighter-rouge">A</code> 网站.<li>此时 <code class="language-plaintext highlighter-rouge">A</code> 网站拿到 <code class="language-plaintext highlighter-rouge">tooken(令牌)</code> 就能访问用户在 <code class="language-plaintext highlighter-rouge">B</code> 网站的资源了.</ol><p>有木有很像?<p><code class="language-plaintext highlighter-rouge">CORS</code> 的第一步对应 <code class="language-plaintext highlighter-rouge">AUTH</code> 的第二步. <code class="language-plaintext highlighter-rouge">AUTH</code> 的第二步相当于 <code class="language-plaintext highlighter-rouge">CORS</code> 的第一步的可以认为是在 <code class="language-plaintext highlighter-rouge">B</code> 网站的服务端加上了 <code class="language-plaintext highlighter-rouge">Access-Control-Allow-Credentials</code>, 这样就代表完成授权.<p>可以认为 <code class="language-plaintext highlighter-rouge">CORS</code> 携带 <code class="language-plaintext highlighter-rouge">cookie</code> 是简化版的 <code class="language-plaintext highlighter-rouge">AUTH</code>.<p>以下摘自 <code class="language-plaintext highlighter-rouge">RFC 6749</code><p><img src="https://cdn.jsdelivr.net/gh/xheldon/x_blog-static@master/img/2016/AUTH.png" alt="AUTH" title="AUTH" /><h2 id="后记">后记</h2><p>为什么说, 第三方广告 <code class="language-plaintext highlighter-rouge">cookie</code> 会泄露隐私呢? 这是因为广告放在一个 <code class="language-plaintext highlighter-rouge">A</code> 网站上, 广告主就知道这个广告投放到了 <code class="language-plaintext highlighter-rouge">A</code> 网站(通过广告投放的 <code class="language-plaintext highlighter-rouge">id/key</code> 之类的 <code class="language-plaintext highlighter-rouge">identity</code> 来标识 和付费), 于是广告主在这个广告上设置一个 <code class="language-plaintext highlighter-rouge">cookie</code>, 这个广告来自广告 <code class="language-plaintext highlighter-rouge">B</code> 的域名, 因此设置的 <code class="language-plaintext highlighter-rouge">cookie</code> 当然是来自 <code class="language-plaintext highlighter-rouge">B</code> 的 <code class="language-plaintext highlighter-rouge">cookie</code>, 每次 <code class="language-plaintext highlighter-rouge">A</code> 网站加载这个广告的时候, 肯定是要执行一段 <code class="language-plaintext highlighter-rouge">js</code> 的, 在这个 <code class="language-plaintext highlighter-rouge">js</code> 中, 设置了允许 <code class="language-plaintext highlighter-rouge">A</code> 站发送 <code class="language-plaintext highlighter-rouge">cookie</code>, 而同时 <code class="language-plaintext highlighter-rouge">B</code> 站也允许来自 <code class="language-plaintext highlighter-rouge">A</code> 站的 <code class="language-plaintext highlighter-rouge">cookie</code> 携带 <code class="language-plaintext highlighter-rouge">B</code> 站的 <code class="language-plaintext highlighter-rouge">cookie</code> 发送过来, 因此就什么都知道了.<p>`Google AD Impl:<p><img src="https://cdn.jsdelivr.net/gh/xheldon/x_blog-static@master/img/2016/googleWithCredentials.png" alt="googleWithCredientials" title="googleWithCredientials" /><p><img src="https://cdn.jsdelivr.net/gh/xheldon/x_blog-static@master/img/2016/googleWithCredentials2.png" alt="googleWithCredientials2" title="googleWithCredientials2" /><h2 id="注意">注意</h2><ol><li><p>上述修改涉及到服务端的修改, 均需要重启服务. 因为在 <code class="language-plaintext highlighter-rouge">VPS</code> 上重启服务不太方便, 而且时间久了连接会断开, 因此最好的办法是在 <code class="language-plaintext highlighter-rouge">VPS</code> 上放置文章中的 <code class="language-plaintext highlighter-rouge">a.com</code> (主要用来修改 <code class="language-plaintext highlighter-rouge">index.html</code> 的), 而在本地放置文章中的 <code class="language-plaintext highlighter-rouge">b.com</code> 的内容(主要用来修改 <code class="language-plaintext highlighter-rouge">index.js</code> 的).<li><p>远程链接保持不断开, 最简单的办法是将其后台(前提是保持链接, 不然断开链接之后, 请求过来进行 <code class="language-plaintext highlighter-rouge">I/O</code> 操作, 仍然会被断开). 可以运行 <code class="language-plaintext highlighter-rouge">node index.js &amp;</code>, 或者在已经运行 <code class="language-plaintext highlighter-rouge">node index.js</code> 的时候按 <code class="language-plaintext highlighter-rouge">ctrl+z</code>, 将其冻结在后台, 然后执行 <code class="language-plaintext highlighter-rouge">bg</code> 命令将最近一个后台的任务激活. <code class="language-plaintext highlighter-rouge">jobs</code> 命令可以查看在当前任务列表. 如果退出了当前 <code class="language-plaintext highlighter-rouge">session</code>, 之后重新连接的话, 任务仍然在运行, 但是 <code class="language-plaintext highlighter-rouge">jobs</code> 已经看不到该任务了, 因此需要 <code class="language-plaintext highlighter-rouge">ps -A</code> 列出所有进程, 然后 <code class="language-plaintext highlighter-rouge">kill ID</code> 终止 <code class="language-plaintext highlighter-rouge">node</code> 所在的那个进程, 重新运行即可.<li><p>完成小目标期间出错的时候我怀疑是没有把自定义字段设置为以 <code class="language-plaintext highlighter-rouge">X-</code> 开头才报错的, 看了下标准发现并没有以 <code class="language-plaintext highlighter-rouge">X-</code> 的规定, 维基和SO 上只是推荐自定义 <code class="language-plaintext highlighter-rouge">Header</code> 以 <code class="language-plaintext highlighter-rouge">X-</code> 开头而已.<li><p>设置了 <code class="language-plaintext highlighter-rouge">withCredentials = true</code> 之后, 服务端的 <code class="language-plaintext highlighter-rouge">Access-Control-Allow-Origin</code> 就不能再设置为 <code class="language-plaintext highlighter-rouge">wildcard</code> <code class="language-plaintext highlighter-rouge">*</code> 了</ol></article><div class="page-footer"><hr /> 转载请<a href="/tech/research-CORS.html">注明出处</a>&nbsp;&nbsp;打赏请<a href="/donate/" target="_blank">移步这里</a> <br><br> <span class="EOF">- EOF -</span> <br><br><div class="panel-body"><h4>相同分类:</h4><ul><li class="relatedPost"> <a href="/tech/the-using-of-github-pages.html">免费使用私有仓库发布 GitHub Pages</a> (分类: <a href="/category/Web">Web</a>)<li class="relatedPost"> <a href="/tech/optimize-of-this-site.html">博客优化技巧</a> (分类: <a href="/category/Web">Web</a>)<li class="relatedPost"> <a href="/tech/github-pages-config.html">关于本博客域名优化配置的几点说明</a> (分类: <a href="/category/Web">Web</a>)</ul></div><div class="page-navigation"> <a class="prev" href="/tech/softerware-i-use-usually.html">&laquo; 环境配置/常用软件汇总</a> <a class="next" href="/tech/some-complain.html">一些牢骚 &raquo;</a></div><div id="gitalk-container"></div></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css"> <script src="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js"></script> <script type="text/javascript"> window.addEventListener('load', function(){ var gitalk = new Gitalk({ clientID: 'd2b353a60fa1233163fc', clientSecret: '8091d57674976bcd60fc05261bf93c00da7e5ff4', repo: 'x_blog', owner: 'Xheldon', admin: ['Xheldon'], id: "research-CORS" }); gitalk.render('gitalk-container'); }); </script></main><footer> &copy; 2021 - Xheldon - Theme Powered By Xheldon <span class="footer-social"> <a href="https://twitter.com/_Xheldon" target="_blank"><i class="fab fa-twitter"></i></a> <a href="https://t.me/xheldon_saloon" target="_blank"><i class="fab fa-telegram"></i></a> <a href="https://www.zhihu.com/people/xheldon/pins" target="_blank"><i class="fa" style="font-size: 16px;line-height:2;">知乎</i></a> </span></footer></div><script type="text/javascript"> !function () { function e(t) { var n = {}; if (1 == t.nodeType) { if (t.attributes.length > 0) { n["@attributes"] = {}; for (var i = 0; i < t.attributes.length; i++) { var s = t.attributes.item(i); n["@attributes"][s.nodeName] = s.nodeValue } } } else 3 == t.nodeType && (n = t.nodeValue); var a = [].slice.call(t.childNodes).filter(function (e) { return 3 === e.nodeType }); if (t.hasChildNodes() && t.childNodes.length === a.length) n = [].slice.call(t.childNodes).reduce(function (e, t) { return e + t.nodeValue }, ""); else if (t.hasChildNodes()) for (var r = 0; r < t.childNodes.length; r++) { var o = t.childNodes.item(r), d = o.nodeName; if ("undefined" == typeof n[d]) n[d] = e(o); else { if ("undefined" == typeof n[d].push) { var c = n[d]; n[d] = [], n[d].push(c) } n[d].push(e(o)) } } return n } function t(t) { var n = e(t); return n.channel.item } var n, i = document.querySelector("#js-search"), s = document.querySelector("#js-search__input"), a = document.querySelector("#js-search__results"), r = "", o = [], d = new XMLHttpRequest; d.open("GET", "/sitemap.xml"), d.onreadystatechange = function () { if (4 == d.readyState && (200 == d.status || 304 == d.status)) { var e = (new DOMParser).parseFromString(d.responseText, "text/xml"); e = e.children[0], o = t(e) } }, d.send(), window.toggleSearch = function () { _gaq.push(["_trackEvent", "supersearch", i.classList.contains("is-active")]), i.classList.toggle("is-active"), i.classList.contains("is-active") ? s.value = "" : a.classList.add("is-hidden"), setTimeout(function () { s.focus() }, 210) }, window.addEventListener("keyup", function (e) { 27 === e.which && toggleSearch() }), window.addEventListener("keypress", function (e) { 47 !== e.which || i.classList.contains("is-active") || toggleSearch() }), s.addEventListener("input", function () { var e, t; if (r = (s.value + "").toLowerCase(), !r || r.length < 3) return n = "", void a.classList.add("is-hidden"); a.style.offsetWidth; var i; i = void 0 === o.title ? o.filter(function (e) { return -1 !== (e.title + "").toLowerCase().indexOf(r) || -1 !== (e.description + "").toLowerCase().indexOf(r) ? !0 : void 0 }) : [o], i.length || a.classList.add("is-hidden"), e = i.reduce(function (e, t) { return t.title + e }, ""), i.length && e !== n && (a.classList.remove("is-hidden"), a.innerHTML = i.map(function (e) { return t = new Date(e.pubDate), '<li><a href="' + e.link + '">' + e.title + "</a>" }).join("")), n = e }) }(); </script><link href="https://cdn.jsdelivr.net/gh/xheldon/x_blog-static@master/css/font-awesome.min.css" rel="stylesheet" crossorigin="anonymous"> <script> (function (i, s, o, g, r, a, m) { i['GoogleAnalyticsObject'] = r; i[r] = i[r] || function () { (i[r].q = i[r].q || []).push(arguments) }, i[r].l = 1 * new Date(); a = s.createElement(o), m = s.getElementsByTagName(o)[0]; a.async = 1; a.src = g; m.parentNode.insertBefore(a, m) })(window, document, 'script', 'https://www.google-analytics.com/analytics.js', 'ga'); ga('create', 'UA-79359216-1', 'auto'); ga('send', 'pageview'); </script> <script> document.addEventListener('DOMContentLoaded',function(){ try { Array.prototype.slice.call(document.querySelectorAll('a')).forEach(function(a){ if (!a.getAttribute('target')) { let href = a.getAttribute('href'); let attrs = Object.keys(a.dataset); if (href && href.indexOf('/') && href.indexOf('#')) { a.setAttribute('target', '_blank'); } else { a.setAttribute('target', '_self'); } /* 默认情况下外链在新窗口打开, 本地链接在当前窗口打开 kramdown 可以对 url 设置特殊属性 data-open, 因此用此特性来排除需要在新窗口打开的本地链接 */ if (attrs.length) { attrs.forEach(function(attr){ switch (attr) { case 'open': a.setAttribute('target', '_blank'); break; default: break; } }); } } }); } catch (e) { console.log('新窗口打开链接失败:', e); } /*try { let toc = document.getElementById('post-toc'); if (toc) { function setPosition() { let offset = toc.parentElement.getBoundingClientRect().y; if (offset <= 50) { toc.style.position = 'fixed'; toc.style.top = '50px'; } else { toc.style.position = 'absolute'; toc.style.top = '0'; } } setPosition(); window.addEventListener('scroll', setPosition); } } catch(e) { console.log('toc滚动失败'); }*/ }); </script>
